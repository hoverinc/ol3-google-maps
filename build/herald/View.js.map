{"version":3,"file":"View.js","sources":["../../src/olgm/herald/View.js"],"sourcesContent":["/**\n * @module olgm/herald/View\n */\nimport {transform} from 'ol/proj.js';\nimport {getZoomFromResolution} from '../util.js';\nimport {listen, unlistenByKey} from '../events.js';\nimport Herald from './Herald.js';\nimport PropertyListener from '../listener/PropertyListener.js';\nimport Listener from '../listener/Listener.js';\n\nclass ViewHerald extends Herald {\n  /**\n   * The View Herald is responsible of synchronizing the view (center/zoom)\n   * of boths maps together. The ol3 map view is the master here, i.e. changes\n   * from the ol3 map view are given to the gmap map, but not vice-versa.\n   *\n   * When the browser window gets resized, the gmap map is also updated.\n   *\n   * @param {module:ol/PluggableMap} ol3map openlayers map\n   * @param {google.maps.Map} gmap google maps map\n   */\n  constructor(ol3map, gmap) {\n    super(ol3map, gmap);\n\n    /**\n     * On window resize, the GoogleMaps map gets recentered. To avoid doing this\n     * too often, a timeout is set.\n     * @type {?number}\n     * @private\n     */\n    this.windowResizeTimerId_ = null;\n\n    /**\n     * @type {?module:ol/events~EventsKey}\n     * @private\n     */\n    this.windowListenerKey_ = null;\n  }\n\n\n  /**\n   * @inheritDoc\n   */\n  activate() {\n    super.activate();\n\n    this.listener = new PropertyListener(this.ol3map, null, 'view', (view, oldView) => {\n      if (oldView) {\n        this.setRotation();\n        this.setCenter();\n        this.setZoom();\n      }\n\n      return new Listener([\n        // listen to center change\n        view.on('change:center', () => this.setCenter()),\n        // listen to resolution change\n        view.on('change:resolution', () => this.setZoom()),\n        // listen to rotation change\n        view.on('change:rotation', () => this.setRotation())\n      ]);\n    });\n\n    // listen to browser window resize\n    this.windowListenerKey_ = listen(\n      window,\n      'resize',\n      this.handleWindowResize_,\n      this,\n      false);\n\n    // Rotate and recenter the map after it's ready\n    google.maps.event.addListenerOnce(this.gmap, 'idle', () => {\n      this.setRotation();\n      this.setCenter();\n      this.setZoom();\n    });\n  }\n\n\n  deactivate() {\n    super.deactivate();\n\n    unlistenByKey(this.windowListenerKey_);\n  }\n\n\n  /**\n   * Recenter the gmap map at the ol3 map center location.\n   */\n  setCenter() {\n    const view = this.ol3map.getView();\n    const projection = view.getProjection();\n    const center = view.getCenter();\n    if (Array.isArray(center)) {\n      const [lng, lat] = transform(center, projection, 'EPSG:4326');\n      this.gmap.setCenter(new google.maps.LatLng(lat, lng));\n    }\n  }\n\n\n  /**\n   * Rotate the gmap map like the ol3 map. The first time it is ran, the map\n   * will be resized to be a square.\n   */\n  setRotation() {\n    const view = this.ol3map.getView();\n    const rotation = view.getRotation();\n\n    const mapDiv = this.gmap.getDiv();\n    let childDiv;\n    for (let i = 0; i < mapDiv.childNodes.length; i++) {\n      const child = mapDiv.childNodes[i];\n      if (child.nodeName === 'DIV') {\n        childDiv = child;\n        break;\n      }\n    }\n    const tilesDiv = childDiv.childNodes[0];\n\n    // If googlemaps is fully loaded\n    if (tilesDiv) {\n\n      // Rotate the div containing the map tiles\n      const tilesDivStyle = tilesDiv.style;\n      tilesDivStyle.transform = 'rotate(' + rotation + 'rad)';\n\n      const width = this.ol3map.getSize()[0];\n      const height = this.ol3map.getSize()[1];\n\n      // Change the size of the rendering area to a square\n      if (width != height && rotation != 0) {\n        const sideSize = Math.max(width, height);\n        const mapDivStyle = mapDiv.style;\n        mapDivStyle.width = sideSize + 'px';\n        mapDivStyle.height = sideSize + 'px';\n\n        // Hide the overflow\n        this.ol3map.getTargetElement().style.overflow = 'hidden';\n\n        // Adjust the map's center to offset with the new size\n        const diffX = width - sideSize;\n        const diffY = height - sideSize;\n\n        tilesDivStyle.top = (diffY / 2) + 'px';\n        tilesDivStyle.left = (diffX / 2) + 'px';\n\n        // Trigger a resize event\n        google.maps.event.trigger(this.gmap, 'resize');\n\n        // Replace the map\n        this.setCenter();\n        this.setZoom();\n\n        // Move up the elements at the bottom of the map\n        const childNodes = childDiv.childNodes;\n        for (let i = 0; i < childNodes.length; i++) {\n          // Set the bottom to where the overflow starts being hidden\n          const style = childNodes[i].style;\n          if (style.bottom == '0px') {\n            style.bottom = Math.abs(diffY) + 'px';\n          }\n        }\n\n        // Set the ol3map's viewport size to px instead of 100%\n        const viewportStyle = this.ol3map.getViewport().style;\n        if (viewportStyle.height == '100%') {\n          viewportStyle.height = height + 'px';\n        }\n      }\n    }\n  }\n\n\n  /**\n   * Set the gmap map zoom level at the ol3 map view zoom level.\n   */\n  setZoom() {\n    const resolution = this.ol3map.getView().getResolution();\n    if (typeof resolution === 'number') {\n      const zoom = getZoomFromResolution(resolution);\n      this.gmap.setZoom(zoom);\n    }\n  }\n\n\n  /**\n   * Called when the browser window is resized. Set the center of the GoogleMaps\n   * map after a slight delay.\n   * @private\n   */\n  handleWindowResize_() {\n    if (this.windowResizeTimerId_) {\n      window.clearTimeout(this.windowResizeTimerId_);\n    }\n    this.windowResizeTimerId_ = window.setTimeout(\n      this.setCenterAfterResize_.bind(this),\n      100);\n  }\n\n\n  /**\n   * Called after the browser window got resized, after a small delay.\n   * Set the center of the GoogleMaps map and reset the timeout.\n   * @private\n   */\n  setCenterAfterResize_() {\n    this.setCenter();\n    this.windowResizeTimerId_ = null;\n  }\n}\nexport default ViewHerald;\n"],"names":["super","this","const","i","let"],"mappings":"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"}